{% extends 'base.html' %}
{% load static %}

{% block title %}LungSafe - Evaluación de Riesgo{% endblock %}

{% block content %}
<div class="container mt-0" style="margin-top: -40px !important; max-width: 800px;">
    <!-- Contenedor Superior -->
    <div class="shadow-sm p-4 mb-4 text-center" style="background-color: #f9f9f9; border-radius: 15px; border: 2px solid #007BFF;">
        <h2 class="text-primary">LungSafe: Evaluación de Riesgo</h2>
        <p class="text-muted">Completa este formulario para proceder al análisis.</p>

        <!-- Navegación por números -->
        <ul class="nav nav-pills justify-content-center">
            {% for step in "123456789" %}
            <li class="nav-item">
                <button class="nav-link {% if forloop.first %}active{% endif %}" onclick="goToTab('step{{ step }}')">{{ step }}</button>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Formulario principal -->
    <div class="form-card shadow p-4 mx-auto" style="max-width: 800px;">
        <form id="multi-step-form" method="post" action="{% url 'core:patient_data_form_guided' %}">
            {% csrf_token %}
            <div class="tab-content px-4">
                {% include 'core/partials/form_step1.html' %}
                {% include 'core/partials/form_step2.html' %}
                {% include 'core/partials/form_step3.html' %}
                {% include 'core/partials/form_step4.html' %}
                {% include 'core/partials/form_step5.html' %}
                {% include 'core/partials/form_step6.html' %}
                {% include 'core/partials/form_step7.html' %}
                {% include 'core/partials/form_step8.html' %}
                {% include 'core/partials/form_step9.html' %}
                <!-- Más steps según sea necesario -->
            </div>
        
            <p>Step actual: {{ current_step }}</p>

            <!--Botón enviar-->
            <div class="d-flex align-items-start justify-content-center mt-4">
                {% if current_step == 9 %}
                <div class="col-4">
                    <button type="submit" class="btn btn-success" id="submitBtn" style="width: 150px;">holi</button>
                </div>
                {% endif %}
            </div>
        </form>
    </div>


</div>

<!-- Scripts -->
<script>
    // Inicializar el array de respuestas
    const userResponses = [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    console.log("Array inicializado:", userResponses);

    // Mostrar mensaje emergente y marcar errores
    function validateAndHighlight(field, message) {
        field.classList.add("is-invalid");
        alert(message);
        console.log("Validación fallida:", message);
    }

    // Validar el campo AGE
    function validateAGE(nextTabId) {
        const ageField = document.querySelector('[name="AGE"]');
        const ageValue = parseInt(ageField.value, 10);

        if (isNaN(ageValue) || ageValue < 21 || ageValue > 87) {
            validateAndHighlight(ageField, "La edad debe ser un número entre 21 y 87.");
            return false;
        } else {
            ageField.classList.remove("is-invalid");
            userResponses[0] = ageValue;
            console.log("Validación exitosa de AGE. Array actualizado:", userResponses);
            goToTab(nextTabId);
            return true;
        }
    }

    // Manejar cambios en el campo GENDER
    function updateGender() {
        const genderRadios = document.querySelectorAll('[name="GENDER"]');
        genderRadios.forEach((radio) => {
            if (radio.checked) {
                userResponses[1] = parseInt(radio.value);
                console.log("Cambio en GENDER detectado. Array actualizado:", userResponses);
            }
        });
    }

    // Cambiar a un tab específico
    function goToTab(tabId) {
        const currentTab = document.querySelector('.tab-pane.active');
        const targetTab = document.getElementById(tabId);

        if (currentTab && targetTab) {
            currentTab.classList.remove('show', 'active');
            targetTab.classList.add('show', 'active');
            console.log(`Cambio de tab realizado. Tab actual: ${tabId}`);
        } else {
            console.error("Error al cambiar de tab:", { currentTab, targetTab });
        }
    }

    // Escuchar cambios en checkboxes
    function initializeCheckboxListeners() {
        const checkboxMappings = {
            "id_SMOKING": 2,
            "id_YELLOW_FINGERS": 3,
            "id_PEER_PRESSURE": 5,
            "id_ALCOHOL_CONSUMING": 10,
            "id_ANXIETY": 4,
            "id_SWALLOWING_DIFFICULTY": 7,
            "id_FATIGUE": 6,
            "id_CHEST_PAIN": 14,
            "id_ALLERGY": 8,
            "id_COUGHING": 9,
            "id_CHRONIC_DISEASE": 13,
            "id_SHORTNESS_OF_BREATH": 11,
            "id_WHEEZING": 12
        };

        Object.keys(checkboxMappings).forEach((checkboxId) => {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.addEventListener("change", () => {
                    const index = checkboxMappings[checkboxId];
                    userResponses[index] = checkbox.checked ? 1 : 0;
                    console.log(`Cambio en ${checkboxId}. Array actualizado:`, userResponses);
                });
            } else {
                console.warn(`Checkbox con ID ${checkboxId} no encontrado en el DOM.`);
            }
        });
    }

    // Función para generar el resumen
    function generateSummary() {
        console.log("Generando resumen...");
        const userSummary = document.getElementById("userSummary");
        if (userSummary) {
            userSummary.innerHTML = "";
            console.log("Limpiando contenido previo del resumen...");

            const summary = [
                `Edad: ${userResponses[0]}`,
                `Sexo: ${userResponses[1] === 1 ? "Hombre" : "Mujer"}`,
                `Fuma: ${userResponses[2] === 1 ? "Sí" : "No"}`,
                `Dedos amarillos: ${userResponses[3] === 1 ? "Sí" : "No"}`,
                `Ansiedad: ${userResponses[4] === 1 ? "Sí" : "No"}`,
                `Presión de grupo: ${userResponses[5] === 1 ? "Sí" : "No"}`,
                `Fatiga: ${userResponses[6] === 1 ? "Sí" : "No"}`,
                `Dificultad para tragar: ${userResponses[7] === 1 ? "Sí" : "No"}`,
                `Alergias: ${userResponses[8] === 1 ? "Sí" : "No"}`,
                `Tos: ${userResponses[9] === 1 ? "Sí" : "No"}`,
                `Consumo de alcohol: ${userResponses[10] === 1 ? "Sí" : "No"}`,
                `Falta de aire: ${userResponses[11] === 1 ? "Sí" : "No"}`,
                `Sibilancias: ${userResponses[12] === 1 ? "Sí" : "No"}`,
                `Enfermedades crónicas: ${userResponses[13] === 1 ? "Sí" : "No"}`,
                `Dolor en el pecho: ${userResponses[14] === 1 ? "Sí" : "No"}`
            ];

            summary.forEach((item) => {
                const listItem = document.createElement("li");
                listItem.textContent = item;
                listItem.classList.add("list-group-item");
                userSummary.appendChild(listItem);
            });

            console.log("Resumen generado exitosamente.");
        } else {
            console.error("Elemento 'userSummary' no encontrado.");
        }
    }

    // Inicializar eventos al cargar el DOM
    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM cargado. Inicializando listeners...");

        // Inicializar listeners de checkboxes
        initializeCheckboxListeners();

        // Validar AGE
        const nextBtnStep1 = document.querySelector("#nextBtn");
        if (nextBtnStep1) {
            nextBtnStep1.addEventListener("click", (e) => {
                e.preventDefault();
                validateAGE('step2');
            });
        }

        // Escuchar cambios en GENDER
        const genderRadios = document.querySelectorAll('[name="GENDER"]');
        if (genderRadios.length) {
            genderRadios.forEach((radio) => {
                radio.addEventListener("change", updateGender);
            });
        }

        // Unificar eventos para todos los botones hacia step9
        const buttonsToStep9 = document.querySelectorAll('button[onclick="goToTab(\'step9\')"]');
        buttonsToStep9.forEach((button) => {
            button.removeAttribute("onclick"); // Remover evento inline
            button.addEventListener("click", (e) => {
                e.preventDefault();
                console.log("Botón hacia 'step9' presionado. Generando resumen...");
                generateSummary();
                goToTab("step9");
            });
        });

        console.log(`${buttonsToStep9.length} botones hacia 'step9' inicializados.`);
    });

    const submitBtn = document.getElementById("submitBtn");
    if (submitBtn) {
        submitBtn.addEventListener("click", () => {
            console.log("Botón 'Enviar' presionado.");
            fillFormAndSubmit(); // Llama a una función que implementaremos después
        });
    }

    function fillFormAndSubmit(event) {
    if (event) {
        event.preventDefault(); // Prevenir el envío predeterminado del formulario
    }

    console.log("Llenando el formulario con los datos del array...");

    // Recorre el array `userResponses` y asigna los valores al formulario
    const fieldMappings = [
        "AGE", "GENDER", "SMOKING", "YELLOW_FINGERS", "ANXIETY",
        "PEER_PRESSURE", "CHRONIC_DISEASE", "FATIGUE", "ALLERGY",
        "WHEEZING", "ALCOHOL_CONSUMING", "COUGHING", "SHORTNESS_OF_BREATH",
        "SWALLOWING_DIFFICULTY", "CHEST_PAIN"
    ];


    fieldMappings.forEach((fieldName, index) => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
            // Usa setAttribute para reflejar los datos correctamente en el formulario
            field.setAttribute("value", userResponses[index]);
            console.log(`Campo ${fieldName} actualizado a: ${userResponses[index]}`);
        } else {
            console.warn(`Campo ${fieldName} no encontrado en el formulario.`);
        }
    });

    // Verificar si el formulario existe antes de enviarlo
    const form = document.getElementById("multi-step-form");
    if (form) {
        console.log("Formulario antes de envío (previsualización):");
        console.dir(new FormData(form)); // Muestra el contenido del formulario

        console.log("Formulario listo para envío.");
        
        // **Descomentar esta línea para enviar el formulario automáticamente**
        form.submit(); // Esto enviará los datos al servidor
    } else {
        console.error("Formulario no encontrado.");
    }
}


</script>


{% endblock %}
